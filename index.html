<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8">
  <title>Meter Search</title>
</head>
<body style="display: block;text-align: center;margin: 0 auto;width: 100%;font-size: 25px;font-weight: bold;">

<h3>ਇੱਥੇ ਸੀਰਿਲ ਨੰਬਰ ਭਰਦੇ</h3>

<input type="text" id="search" placeholder="Enter Meter Serial Number">
<button onclick="search()">Search</button>

<pre id="result" style="margin-top: 20px; font-family: sans-serif;"></pre>

<script>
let data = [];
let loaded = false;

fetch("data.csv")
  .then(res => res.text())
  .then(text => {
    // Remove BOM and split rows
    let rows = text.replace(/\uFEFF/g,"").trim().split("\n").slice(1);

    rows.forEach(r => {
      // Basic split by comma
      let c = r.split(",");
      
      if (c.length >= 5) {
        // The meter serial number is always the LAST column
        let rawMeter = c[c.length - 1].replace(/"/g,"").trim();
        // Extract only digits for searching
        let meterDigits = rawMeter.replace(/\D/g,"");

        // The address is everything between column 3 and the last column
        let addressPart = c.slice(3, -1).join(",").replace(/"/g, "").trim();

        data.push({
          acct: c[0].replace(/"/g,"").trim(),
          legacy: c[1].replace(/"/g,"").trim(),
          name: c[2].replace(/"/g,"").trim(),
          address: addressPart,
          meter: meterDigits
        });
      }
    });

    loaded = true;
    document.getElementById("result").textContent = "✅ Data ready (" + data.length + " records)";
  })
  .catch(err => {
    document.getElementById("result").textContent = "❌ Error loading CSV";
    console.error(err);
  });

function search() {
  let out = document.getElementById("result");

  if (!loaded) {
    out.textContent = "⏳ Data load ho rahi aa…";
    return;
  }

  let input = document.getElementById("search").value;
  let userDigits = input.replace(/\D/g,"");

  if (!userDigits) {
    out.textContent = "❌ Meter serial number bharo";
    return;
  }

  // Find exact or partial match, ensuring we don't match empty strings
  let found = data.find(d => 
    d.meter !== "" && d.meter.includes(userDigits)
  );

  if (found) {
    out.textContent =
      "Account ID: " + found.acct + "\n" +
      "Legacy Account: " + found.legacy + "\n" +
      "Name: " + found.name + "\n" +
      "Address: " + found.address + "\n" +
      "Meter: " + found.meter;
  } else {
    out.textContent = "❌ ਹੈ ਨੀ ਭਰਾਵਾ ਕੁਝ ਜਾ ਕੇ ਡਵੀਜ਼ਨ ਚੋਂ ਬਣਵਾਲਾ ਬਿੱਲ ਇਹਦਾ";
  }
}
</script>

</body>

</html>
